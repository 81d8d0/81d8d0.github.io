<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•æŠ½ç</title>
    
    <script>
    /* åŸç”Ÿç‘èŠ±å¼•æ“ */
    window.confetti = (function () {
        var defaultColors = ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff'];
        var particles = [];
        var animationId = null;
        var canvas = null;
        var ctx = null;

        function createParticles(options) {
            var width = window.innerWidth;
            var height = window.innerHeight;
            var count = options.particleCount || 50;
            var x = options.origin ? options.origin.x * width : width / 2;
            var y = options.origin ? options.origin.y * height : height / 2;
            var colors = options.colors || defaultColors;
            var spread = options.spread || 45;
            var startVelocity = options.startVelocity || 45;

            for (var i = 0; i < count; i++) {
                var angle = (options.angle || 90) * (Math.PI / 180);
                var spreadAngle = (Math.random() * spread - spread / 2) * (Math.PI / 180);
                var velocity = startVelocity * (0.5 + Math.random() * 0.5);
                var p = {
                    x: x, y: y,
                    colors: colors, color: colors[(Math.random() * colors.length) | 0],
                    diameter: Math.random() * 8 + 4,
                    tilt: Math.random() * 10 - 10, tiltAngleIncrement: Math.random() * 0.07 + 0.05, tiltAngle: 0,
                    vx: velocity * Math.cos(angle + spreadAngle),
                    vy: -velocity * Math.sin(angle + spreadAngle),
                    gravity: 0.8, drag: 0.95, tick: 0, life: 250
                };
                particles.push(p);
            }
        }

        function draw() {
            if (!ctx) return;
            var width = window.innerWidth;
            var height = window.innerHeight;
            ctx.clearRect(0, 0, width, height);
            var remainingParticles = [];
            particles.forEach(function(p) {
                p.tick++;
                p.x += p.vx; p.y += p.vy; p.vy += p.gravity;
                p.vx *= p.drag; p.vy *= p.drag;
                p.tiltAngle += p.tiltAngleIncrement;
                ctx.beginPath();
                ctx.lineWidth = p.diameter;
                ctx.strokeStyle = p.color;
                var x = p.x + p.tilt;
                var y = p.y + p.tilt + (p.diameter / 2);
                ctx.moveTo(x, p.y);
                ctx.lineTo(x + p.tilt + Math.sin(p.tiltAngle) * 10, y + Math.sin(p.tiltAngle) * 10);
                ctx.stroke();
                if (p.y < height + 50 && p.tick < p.life) remainingParticles.push(p);
            });
            particles = remainingParticles;
            if (particles.length > 0) animationId = requestAnimationFrame(draw);
            else { if(canvas && canvas.parentNode) document.body.removeChild(canvas); canvas = null; ctx = null; animationId = null; }
        }

        return function (options) {
            if (!canvas) {
                canvas = document.createElement("canvas");
                canvas.style.position = "fixed";
                canvas.style.top = "0"; canvas.style.left = "0";
                canvas.style.width = "100%"; canvas.style.height = "100%";
                canvas.style.pointerEvents = "none";
                canvas.style.zIndex = options.zIndex || 9999; 
                document.body.appendChild(canvas);
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                ctx = canvas.getContext("2d");
                window.addEventListener('resize', function() { if(canvas) { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }});
            }
            createParticles(options);
            if (!animationId) draw();
        };
    })();
    </script>

    <style>
        /* --- å…¨å±€è®Šæ•¸ --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #ff4b1f 0%, #990000 100%); 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            --primary-color: #F22D42; 
            --text-color: #2d3436;
            --accent-color: #d35400;
            --red-color: #c0392b; 
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0; padding: 20px;
            background: var(--bg-gradient);
            color: var(--text-color);
            height: 100vh; width: 100vw;
            box-sizing: border-box;
            display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            position: relative; 
        }

        /* é é¦– */
        header { 
            text-align: center; margin-bottom: 15px; color: white; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.5); flex-shrink: 0; 
            position: relative; z-index: 60; 
        }
        
        h1 { margin: 0; font-size: 2.2em; letter-spacing: 2px; font-weight: 800; }

        /* V72 é­ç‚®åœ–å±¤ç´š 150 - ç¢ºä¿åœ¨ DrawBox (z:2) ä¹‹ä¸Š */
        body::after {
            content: ""; position: absolute; top: 0; right: 0;
            width: 100%; height: 100%; pointer-events: none; 
            z-index: 150; 
            background-image: url('firecrackers.png');
            background-repeat: no-repeat;
            background-position: right 440px top 0;
            background-size: auto; opacity: 0.6; 
            filter: drop-shadow(5px 10px 10px rgba(0,0,0,0.3));
        }

        /* ä¸»å®¹å™¨ */
        .main-container { 
            display: flex; gap: 20px; flex: 1; width: 100%; min-height: 0; 
            position: relative; z-index: 20; 
        }

        .panel {
            background: var(--glass-bg);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: var(--glass-border); border-radius: 20px;
            box-shadow: var(--glass-shadow); padding: 20px;
            display: flex; flex-direction: column;
        }

        /* --- å·¦å´è¨­å®šé¢æ¿ --- */
        .panel-settings { width: 240px; min-width: 240px; flex-shrink: 0; gap: 15px; overflow-y: auto; }
        .settings-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: center; color: #000; font-size: 0.8em;}

        /* --- ä¸­é–“æŠ½çé¢æ¿ --- */
        .panel-draw { 
            flex: 1; align-items: center; justify-content: center; position: relative; 
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
            border: 2px solid #f1c40f; 
            box-shadow: 0 10px 40px rgba(211, 84, 0, 0.5);
            overflow: hidden; 
        }

        /* é¦¬åŒ¹èƒŒæ™¯ */
        .panel-draw::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('horses.png');
            background-repeat: no-repeat;
            background-position: center bottom;
            background-size: 100% auto; opacity: 0.2; 
            z-index: 0; pointer-events: none; 
        }
        
        .panel-draw > * { position: relative; z-index: 2; }

        .current-prize-info {
            font-size: 1.8em; font-weight: bold; margin-bottom: 20px; text-align: center; 
            background: rgba(255, 255, 255, 0.9);
            color: #d35400; padding: 10px 20px;
            border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none; animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- ä¸­é–“æŠ½çé¡¯ç¤ºæ¡† --- */
        .draw-box {
            width: 90%; min-height: 350px; max-height: 80vh; 
            background: linear-gradient(to bottom, #ffffff, #fff0f1);
            border-radius: 25px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            margin-bottom: 20px; 
            border: 4px solid #ffccd2;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 0 20px rgba(242, 45, 66, 0.05);
            text-align: center; padding: 20px; transition: all 0.3s;
            overflow-y: auto; overflow-x: hidden;
            position: relative; 
        }
        
        .draw-box.active { 
            transform: scale(1.02); 
            border-color: #F22D42; 
            box-shadow: 0 0 30px rgba(242, 45, 66, 0.4); 
            background: #fff;
        }
        
        .draw-box.show-results { justify-content: flex-start; }

        /* æµ®æ°´å°å±¤ */
        .bg-watermark-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden; border-radius: 25px;
        }

        /* ã€Œæ˜¥ã€å­—è£é£¾ */
        .wm-decor {
            position: absolute; top: 15px; left: 20px;
            width: 140px; height: 140px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="%23c0392b" stroke="%23f1c40f" stroke-width="2"/><text x="50" y="70" font-size="60" text-anchor="middle" fill="%23f1c40f" font-weight="bold" font-family="Microsoft JhengHei, sans-serif">æ˜¥</text></svg>');
            background-repeat: no-repeat; background-size: contain;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.1));
            animation: swing 3s infinite ease-in-out; opacity: 0.3; 
        }
        @keyframes swing { 0%,100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }

        /* --- æŠ½çæ–‡å­—èˆ‡çµæœæ¨£å¼ --- */
        .box-rolling-text { font-size: 4em; font-weight: bold; color: #2f3542; margin: auto; position: relative; z-index: 5; }
        .box-prize-name-huge { font-size: 5em; font-weight: bold; color: #36517a; line-height: 1.1; text-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; z-index: 5; }
        .box-prize-amount-huge { font-size: 3.5em; color: #e74c3c; font-weight: bold; margin-bottom: 15px; position: relative; z-index: 5; }
        .box-divider { width: 60%; height: 3px; background: #eee; margin: 15px 0; position: relative; z-index: 5; }
        .box-winners-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px 25px; width: 100%; padding: 10px; background: transparent; box-shadow: none; border: none; animation: fadeInGrid 0.5s ease backwards; position: relative; z-index: 5; }
        @keyframes fadeInGrid { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .box-winner-tag { font-size: 3.8em; font-weight: bold; color: #2c3e50; background: transparent; padding: 5px 15px; border-radius: 0; box-shadow: none; animation: popIn 0.5s ease backwards; text-shadow: none; border-bottom: 2px solid #ecf0f1; }
        .box-winner-tag.small-text { font-size: 2em; padding: 2px 10px; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- æ§åˆ¶æŒ‰éˆ• --- */
        .controls { display: flex; gap: 20px; margin-top: 10px; }
        .action-btn { padding: 15px 45px; font-size: 1.3em; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; letter-spacing: 1px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s; }
        .action-btn:active { transform: scale(0.96); }
        .btn-start { background: linear-gradient(135deg, rgba(20, 30, 80, 0.75) 0%, rgba(50, 40, 150, 0.75) 100%); border: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(3px); text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .btn-start:hover { background: linear-gradient(135deg, rgba(30, 40, 100, 0.85) 0%, rgba(60, 50, 180, 0.85) 100%); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .action-btn:disabled { background: rgba(100,100,100,0.5); cursor: not-allowed; transform: none; box-shadow: none; border-color:transparent; }

        /* --- å³å´çµæœé¢æ¿ --- */
        .panel-results { width: 420px; min-width: 420px; flex-shrink: 0; overflow: hidden; }
        .results-header { display:flex; justify-content:space-between; align-items: center; margin-bottom:10px; position:relative; z-index:5; }
        .results-header label { margin: 0; font-size: 1.1em; color: #2d3436; }

        .input-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        label { font-weight: bold; color: #2d3436; font-size: 0.95em; }
        textarea, input[type="text"] { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; resize: vertical; font-family: inherit; box-sizing: border-box; font-size: 13px; background: #fff; color: #2d3436; }
        textarea:focus, input[type="text"]:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 5px rgba(242, 45, 66, 0.3); }
        .hint { font-size: 0.85em; color: #636e72; margin-top: 4px; }
        
        /* ä¿®æ”¹å¾Œçš„åŒ¯å…¥æŒ‰éˆ•æ¨£å¼ (ç°ç™½æ¼¸å±¤) */
        .btn-import { 
            background: linear-gradient(to bottom, #f9f9f9, #e0e0e0);
            color: #555;
            border: 1px solid #ccc;
            border-radius: 6px; 
            padding: 4px 10px; 
            font-size: 0.85em; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            transition: all 0.2s;
        }
        .btn-import:hover { 
            background: linear-gradient(to bottom, #ffffff, #efefef);
            color: #2d3436;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        /* æ–°å¢ï¼šå³ä¸Šè§’åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ (èˆ‡åŒ¯å…¥ã€æ‰¹æ¬¡åŒ¯å‡ºåŒé¢¨æ ¼) */
        .btn-header-export {
            background: linear-gradient(to bottom, #f9f9f9, #e0e0e0);
            color: #555;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .btn-header-export:hover {
            background: linear-gradient(to bottom, #ffffff, #efefef);
            color: #2d3436;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-batch-export { 
            background: linear-gradient(to bottom, #f9f9f9, #e0e0e0); 
            color: #555; 
            padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: all 0.2s; 
        }
        .btn-batch-export:hover { 
            background: linear-gradient(to bottom, #ffffff, #efefef);
            color: #2d3436;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); 
            transform: translateY(-1px);
        }
        .btn-batch-export:active { transform: translateY(0); }
        .btn-batch-export:disabled { background: #eee; color: #bbb; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .results-list { flex: 1; overflow-y: auto; margin-top: 10px; background: rgba(255,255,255,0.85); border-radius: 12px; border: 1px solid #ddd; position: relative; z-index: 5; }
        .results-list:empty { background-image: url('nowhorse.png'); background-repeat: no-repeat; background-position: center; background-size: auto 100%; }
        
        .result-item { padding: 12px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .result-name { font-weight: bold; color: #2d3436; font-size: 1.7em; } 
        .file-input-hidden { display: none; }

        @media (max-width: 900px) {
            body { height: auto; }
            .main-container { flex-direction: column; height: auto; }
            .panel-settings { width: 100%; min-width: 0; }
            .panel-results { width: 100%; min-width: 0; }
            .panel { min-height: 400px; margin-bottom: 20px; }
            .box-prize-name-huge { font-size: 4em; } 
            .box-prize-amount-huge { font-size: 3em; }
        }
    </style>
</head>
<body>

<header>
    <h1 id="pageTitle">æ´»å‹•æŠ½ç</h1>
</header>

<div class="main-container">
    <div class="panel panel-settings">
        <div class="input-group">
            <label>ğŸ“ æ´»å‹•æ¨™é¡Œ</label>
            <input type="text" id="titleInput" value="" oninput="updateTitle()" placeholder="è«‹è¼¸å…¥æ´»å‹•æ¨™é¡Œ">
        </div>

        <div class="input-group">
            <div class="label-row">
                <label>ğŸ çé …è¨­å®š</label>
                <button class="btn-import" onclick="document.getElementById('importPrizesFile').click()">ğŸ“‚ åŒ¯å…¥</button>
                <input type="file" id="importPrizesFile" class="file-input-hidden" accept=".txt,.csv">
            </div>
            <textarea id="prizesInput" rows="2" placeholder="çé …, é‡‘é¡, æ•¸é‡"></textarea>
        </div>

        <div class="input-group">
            <div class="label-row">
                <label>ğŸ‘¥ åƒåŠ åå–®</label>
                <button class="btn-import" onclick="document.getElementById('importCandidatesFile').click()">ğŸ“‚ åŒ¯å…¥</button>
                <input type="file" id="importCandidatesFile" class="file-input-hidden" accept=".txt,.csv">
            </div>
            <textarea id="candidatesInput" rows="11" placeholder="æ¯è¡Œä¸€å€‹åå­—"></textarea>
            <div class="hint">å‰©é¤˜äººæ•¸: <span id="candidateCount" style="color:var(--primary-color); font-weight:bold;">0</span> äºº</div>
            <div class="hint" style="color:var(--red-color); font-size:0.75em;">(ä¸­çè€…å°‡è‡ªå‹•å¾åå–®ç§»é™¤)</div>
        </div>

        <div style="margin-top: auto;">
            <button id="btnBatchExport" class="btn-batch-export" onclick="batchExport()">ğŸ“¦ æ‰¹æ¬¡åŒ¯å‡ºç›®å‰è³‡æ–™</button>
        </div>

        <div class="settings-footer">
            ğŸ’° 2026.2.9 ğŸ’µ
        </div>
    </div>

    <div class="panel panel-draw">
        <div class="current-prize-info" id="currentPrizeDisplay">æº–å‚™å°±ç·’...</div>
        
        <div class="draw-box" id="rollingBox">
            <div class="bg-watermark-layer">
                <div class="wm-decor"></div>
            </div>
            
            <div class="box-rolling-text">Am I ready?</div>
        </div>

        <div class="controls">
            <button class="action-btn btn-start" id="btnStart" onclick="startDraw()">é–‹å§‹æŠ½ç</button>
        </div>
    </div>

    <div class="panel panel-results">
        <div class="results-header">
            <label>ğŸ† ä¸­çåå–®</label>
            <button onclick="exportResults()" class="btn-header-export">ğŸ“¥ åŒ¯å‡º</button>
        </div>
        <div class="results-list" id="resultsList"></div>
    </div>
</div>

<script>
    // --- â˜… å®‰å…¨é˜²è­·å‡ç´šï¼šé˜²æ­¢èª¤é—œé–‰/ä¸Šä¸€é /F5 â˜… ---
    window.addEventListener('beforeunload', function (e) {
        if (winners.length > 0 || candidates.length > 0) {
            e.preventDefault();
            e.returnValue = ''; 
        }
    });

    window.onerror = function(message, source, lineno, colno, error) {
        console.error("Global Error:", message, error);
        return false;
    };

    document.addEventListener('keydown', (e) => {
        const activeTag = document.activeElement.tagName;
        if (activeTag === 'TEXTAREA' || activeTag === 'INPUT') return;
        if (e.code === 'Enter' || e.code === 'Space') {
            e.preventDefault();
            if (!isRunning) startDraw();
        }
    });

    let candidates = [];
    let hasStarted = false;
    let prizes = [];
    let winners = []; 
    let timer = null;
    let isRunning = false;

    window.addEventListener('DOMContentLoaded', () => {
        try {
            updateTitle(); parsePrizes(); parseCandidates(); updateStatusDisplay(); setupFileImports();
            
            document.getElementById('prizesInput').addEventListener('input', () => {
                if (!isRunning) {
                    parsePrizes();
                    updateStatusDisplay();
                    
                    const box = document.getElementById('rollingBox');
                    box.classList.remove('active');
                    box.classList.remove('show-results');
                    
                    const watermarkHtml = document.querySelector('.bg-watermark-layer').outerHTML;
                    box.innerHTML = `${watermarkHtml}<div class="box-rolling-text">ä»Š é¦¬ ç†Š è®š</div>`;
                    
                    document.getElementById('resultsList').innerHTML = '';
                }
            });
        } catch (e) {
            console.error("Initialization error:", e);
        }
    });

    document.getElementById('candidatesInput').addEventListener('input', () => {
        parseCandidates();
    });

    function setupFileImports() {
        document.getElementById('importPrizesFile').addEventListener('change', function(e) { handleFileUpload(e, 'prizesInput', () => { parsePrizes(); updateStatusDisplay(); alert('çé …åŒ¯å…¥å®Œæˆï¼'); }); });
        document.getElementById('importCandidatesFile').addEventListener('change', function(e) { handleFileUpload(e, 'candidatesInput', () => { parseCandidates(); alert(`åå–®åŒ¯å…¥å®Œæˆï¼å…± ${candidates.length} äººã€‚`); hasStarted = false; }); });
    }

    function handleFileUpload(event, targetId, callback) {
        try {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { 
                document.getElementById(targetId).value = e.target.result; 
                if (callback) callback(); 
                event.target.value = ''; 
            };
            reader.onerror = function() { alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€‚"); };
            reader.readAsText(file, "Big5"); 
        } catch(e) {
            alert("åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
        }
    }

    function updateTitle() { const val = document.getElementById('titleInput').value; document.getElementById('pageTitle').innerText = val ? val : "æ´»å‹•æŠ½ç"; }
    
    function parsePrizes() {
        try {
            const text = document.getElementById('prizesInput').value; prizes = [];
            text.split('\n').forEach(line => {
                if (!line.trim()) return;
                let parts = line.replace(/ï¼Œ/g, ',').split(',');
                if (parts.length >= 3) {
                    let name = parts[0].trim();
                    let amount = parts[1].trim();
                    let count = parseInt(parts[2]);
                    if (!isNaN(count)) prizes.push({ name: name, amount: amount, total: count });
                } else if (parts.length === 2) {
                    let name = parts[0].trim();
                    let count = parseInt(parts[1]);
                    if (!isNaN(count)) prizes.push({ name: name, amount: "", total: count });
                }
            });
        } catch(e) {
            console.error("Error parsing prizes:", e);
        }
    }

    function parseCandidates() {
        try {
            const text = document.getElementById('candidatesInput').value;
            candidates = text.split('\n').map(s => s.trim()).filter(s => s !== '');
            document.getElementById('candidateCount').innerText = candidates.length;
        } catch(e) {
            console.error("Error parsing candidates:", e);
        }
    }

    function updateStatusDisplay() {
        const display = document.getElementById('currentPrizeDisplay');
        const btnStart = document.getElementById('btnStart');
        
        if (prizes.length === 0) { 
            display.style.display = "none";
            btnStart.innerText = "æº–å‚™æŠ½ç"; 
            btnStart.disabled = true;
            return; 
        }
        
        const currentPrize = prizes[0]; 
        display.innerHTML = `<span style="color:#d35400;">æ­£åœ¨æŠ½çï¼š</span><span style="color:#e67e22; font-size:1.3em;">${currentPrize.name}</span> <span style="font-size:0.7em; color:#636e72; background:#f1f2f6; padding:2px 8px; border-radius:10px;">å°‡æŠ½å‡º ${currentPrize.total} å</span>`;
        
        display.style.display = "block";
        
        btnStart.innerText = "é–‹å§‹æŠ½ç";
        btnStart.disabled = false;
    }

    function startDraw() {
        try {
            if (!hasStarted && candidates.length > 0) { hasStarted = true; }
            if (prizes.length === 0 || candidates.length === 0) { alert("ç„¡æ³•é–‹å§‹ï¼šè«‹æª¢æŸ¥è¨­å®šæˆ–æ˜¯å¦å·²æŠ½å®Œã€‚"); return; }

            isRunning = true;
            updateStatusDisplay();
            document.getElementById('currentPrizeDisplay').style.display = "block";
            document.getElementById('btnBatchExport').disabled = true;

            const btnStart = document.getElementById('btnStart');
            btnStart.innerText = "æŠ½çä¸­...";
            btnStart.disabled = true;
            
            const box = document.getElementById('rollingBox'); 
            box.classList.add('active');
            box.classList.remove('show-results');
            
            const watermarkHtml = document.querySelector('.bg-watermark-layer').outerHTML;
            box.innerHTML = `${watermarkHtml}<div class="box-rolling-text"></div>`;
            
            const textEl = box.querySelector('.box-rolling-text');

            if (timer) clearInterval(timer);
            timer = setInterval(() => { 
                if (candidates.length > 0) {
                    const randomIndex = Math.floor(Math.random() * candidates.length); 
                    textEl.innerText = candidates[randomIndex]; 
                }
            }, 50);

            setTimeout(() => {
                stopDraw();
            }, 3000); 
        } catch(e) {
            alert("å•Ÿå‹•æŠ½çå¤±æ•—ï¼š" + e.message);
            isRunning = false;
            document.getElementById('btnStart').disabled = false;
        }
    }

    function stopDraw() {
        try {
            if (!isRunning) return;
            clearInterval(timer); isRunning = false;

            document.getElementById('currentPrizeDisplay').style.display = "none";
            document.getElementById('btnBatchExport').disabled = false;

            const prize = prizes[0]; 
            
            let winnersBatch = [];
            let drawCount = prize.total;
            
            if (candidates.length < drawCount) drawCount = candidates.length;
            if (drawCount === 0) throw new Error("å‰©é¤˜åƒåŠ äººæ•¸ç‚º 0ï¼Œç„¡æ³•ç¹¼çºŒæŠ½çã€‚");

            // â˜… æ ¸å¿ƒæŠ½çé‚è¼¯ â˜…
            for (let i = 0; i < drawCount; i++) {
                if (candidates.length === 0) break;
                const idx = Math.floor(Math.random() * candidates.length);
                const winner = candidates[idx];
                if (winner === undefined) continue; 
                winnersBatch.push(winner);
                candidates.splice(idx, 1);
            }

            const box = document.getElementById('rollingBox'); 
            box.classList.remove('active');
            
            const watermarkHtml = document.querySelector('.bg-watermark-layer').outerHTML;
            let centerContent = '';

            if (drawCount > 10) {
                // äººæ•¸ > 10ï¼Œä¸­é–“ä¸é¡¯ç¤ºåå–®ï¼Œåªé¡¯ç¤ºçé …
                box.classList.remove('show-results');
                centerContent = `
                    <div class="box-prize-name-huge" style="margin-bottom: 50px;">${prize.name}</div>
                    <div class="box-prize-amount-huge">${prize.amount}</div>
                `;
            } else {
                // äººæ•¸ <= 10ï¼Œé¡¯ç¤ºåå–®
                box.classList.add('show-results');
                let extraClass = (drawCount > 5) ? 'small-text' : '';
                let winnersHtml = winnersBatch.map(w => `<div class="box-winner-tag ${extraClass}">${w}</div>`).join('');
                centerContent = `
                    <div class="box-prize-name-huge">${prize.name}</div>
                    <div class="box-prize-amount-huge">${prize.amount}</div>
                    <div class="box-divider"></div>
                    <div class="box-winners-grid">${winnersHtml}</div>
                `;
            }
            
            box.innerHTML = watermarkHtml + centerContent;
            
            if (typeof confetti === 'function') {
                triggerConfetti();
            }

            // æ¸…ç©º UI é¡¯ç¤ºï¼Œåªåˆ—å‡ºé€™æ¬¡æŠ½ä¸­çš„äºº
            document.getElementById('resultsList').innerHTML = '';

            winnersBatch.forEach((w, index) => {
                const winData = { prizeName: prize.name, prizeAmount: prize.amount, winner: w };
                // æ¨å…¥å…¨åŸŸé™£åˆ—
                winners.push(winData);

                let displayName = (drawCount > 5) ? `${index + 1}. ${w}` : w;
                addWinnerToDOM(displayName, prize.name);
            });
            
            const resultsList = document.getElementById('resultsList');
            resultsList.scrollTop = 0;

            document.getElementById('candidatesInput').value = candidates.join('\n');
            document.getElementById('candidateCount').innerText = candidates.length;
            
            const prizesInput = document.getElementById('prizesInput');
            let lines = prizesInput.value.split('\n');
            let foundFirst = false;
            let newLines = [];
            for (let line of lines) {
                if (!foundFirst && line.trim() !== "") {
                    foundFirst = true; 
                } else {
                    newLines.push(line);
                }
            }
            prizesInput.value = newLines.join('\n');
            parsePrizes(); 

            updateStatusDisplay(); 

        } catch(e) {
            console.error("StopDraw Error:", e);
            alert("æŠ½çéç¨‹ç™¼ç”Ÿç•°å¸¸ï¼š" + e.message);
            isRunning = false;
            document.getElementById('btnStart').innerText = "é–‹å§‹æŠ½ç";
            document.getElementById('btnStart').disabled = false;
        }
    }

    function triggerConfetti() {
        var duration = 3000; var animationEnd = Date.now() + duration; 
        var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200 }; 
        function random(min, max) { return Math.random() * (max - min) + min; }
        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) return clearInterval(interval);
            var particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
        }, 250);
    }

    function addWinnerToDOM(w, pName) { 
        const c = document.getElementById('resultsList'); 
        const i = document.createElement('div'); 
        i.className = 'result-item'; 
        i.innerHTML = `<span class="result-name">${w}</span>`; 
        c.appendChild(i); 
    }

    // â˜… V77 ä¿®æ­£ï¼šå³ä¸Šè§’åŒ¯å‡ºã€Œå®Œæ•´ã€åå–®ï¼Œä¸¦ä½¿ç”¨ YYYYMMDD æ—¥æœŸæ ¼å¼
    function exportResults() {
        try {
            if (winners.length === 0) { alert("ç›®å‰æ²’æœ‰ä»»ä½•ä¸­çè³‡æ–™"); return; }
            let c = "\uFEFFçé …,é‡‘é¡,å¾—çè€…\n"; 
            winners.forEach(w => c += `${w.prizeName},${w.prizeAmount},${w.winner}\n`);
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            
            downloadFile(c, `å®Œæ•´ä¸­çåå–®_${dateStr}.csv`, 'text/csv');
        } catch(e) {
            alert("åŒ¯å‡ºå¤±æ•—ï¼š" + e.message);
        }
    }

    // â˜… V77 ä¿®æ­£ï¼šæ‰¹æ¬¡åŒ¯å‡ºæª”åæ”¹ç‚º "ç›®å‰ä¸­çå ±è¡¨"
    function batchExport() {
        try {
            const now = new Date();
            const timeStamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            let fileCount = 0;
            let downloadDelay = 0;

            if (winners.length > 0) {
                setTimeout(() => {
                    let content = "\uFEFFçé …,é‡‘é¡,å¾—çè€…\n";
                    winners.forEach(w => content += `${w.prizeName},${w.prizeAmount},${w.winner}\n`);
                    downloadFile(content, `${timeStamp}_ç›®å‰ä¸­çå ±è¡¨.csv`, 'text/csv');
                }, downloadDelay);
                downloadDelay += 300; fileCount++;
            }

            const prizesText = document.getElementById('prizesInput').value.trim();
            if (prizesText) {
                setTimeout(() => {
                    let content = "\uFEFFå‰©é¤˜çé …æ¸…å–®\n\n" + prizesText;
                    downloadFile(content, `${timeStamp}_å‰©é¤˜çé ….txt`, 'text/plain');
                }, downloadDelay);
                downloadDelay += 300; fileCount++;
            }

            if (candidates.length > 0) {
                setTimeout(() => {
                    let content = "\uFEFFå‰©é¤˜åƒåŠ äººå“¡åå–®\nå‰©é¤˜äººæ•¸ï¼š" + candidates.length + "\n\n" + candidates.join('\n');
                    downloadFile(content, `${timeStamp}_å‰©é¤˜äººå“¡.txt`, 'text/plain');
                }, downloadDelay);
                downloadDelay += 300; fileCount++;
            }

            if (fileCount > 0) alert(`ğŸ“¦ å°‡åŒ¯å‡º ${fileCount} å€‹æª”æ¡ˆ...`);
            else alert("âš ï¸ ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        } catch (e) {
            alert("æ‰¹æ¬¡åŒ¯å‡ºå¤±æ•—ï¼š" + e.message);
        }
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url; link.download = filename;
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link); 
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>